<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Chọn phương thức thanh toán an toàn và tiện lợi cho dịch vụ của bạn.">
    <meta name="keywords" content="thanh toán, chuyển khoản, thẻ tín dụng, VNPAY, OnePay">
    <meta property="og:image" content="data/logovnpayqr.png">
    <title>CỔNG THANH TOÁN TRỰC TUYẾN</title>
    <link rel="stylesheet" href="data/styles.css">
    <link rel="icon" type="image/x-icon" href="data/favicon.ico">
    <script defer src="data/html2canvas.min.js"></script>
</head>
<body>
	<div class="container">
		<div id="screenshot-area">
			<h2>CỔNG THANH TOÁN TRỰC TUYẾN</h2>
			<div class="logo-container">
				<img src="data/logovnpayqr.png" alt="Logo VNPAYQR" class="logo" />
				<div class="logo-divider"></div>
				<img src="data/logovietqr.png" alt="Logo VietQR" class="logo" />
			</div>

            <div class="payment-option">
                <label>
                    <input type="radio" name="payment-method" aria-label="Thẻ ATM hoặc Tài khoản ngân hàng">
                    <span>Thẻ ATM/Tài khoản ngân hàng</span>
                    <span class="fee">(Phí giao dịch 1,2%)</span>
                </label>
            </div>

            <div class="payment-option">
                <label>
                    <input type="radio" name="payment-method" aria-label="Thẻ ATM nội địa qua VNPAY">
                    <span>Thẻ ATM nội địa qua VNPAY</span>
                    <span class="fee">(Phí giao dịch 1%)</span>
                </label>
            </div>

            <div class="payment-option">
                <label>
                    <input type="radio" name="payment-method" aria-label="Thẻ tín dụng qua OnePay">
                    <span>Thẻ tín dụng qua OnePay</span>
                    <span class="fee">(Phí giao dịch 3.4%)</span>
                </label>
            </div>

            <div class="payment-option">
                <label>
                    <input type="radio" name="payment-method" aria-label="Thẻ tín dụng qua VNPAY">
                    <span>Thẻ tín dụng qua VNPAY</span>
                    <span class="fee">(Phí giao dịch 2.5%)</span>
                </label>
            </div>

            <div class="bank-transfer">
                <label>
                    <input type="radio" name="payment-method" checked aria-label="Chuyển khoản ngân hàng">
                    <span>Chuyển khoản</span>
                    <span class="fee">(Miễn phí giao dịch)</span>
                </label>
                <p>Sau khi nhận được thông tin đặt dịch vụ, nhân viên chăm sóc khách hàng của chúng tôi sẽ liên hệ với Quý khách để xác nhận và hướng dẫn thêm về thủ tục thanh toán.</p>
                <div class="transfer-container">
                    <div class="transfer-info">
                        <p><strong>Tên tài khoản:</strong> <span id="display-account-name"></span></p>
                        <p><strong>Số tiền:</strong> <span id="display-amount"></span></p>
                        <p><strong>Nội dung:</strong> <span id="display-content"></span><span class="copy" tabindex="0">Copy</span></p>
                        <p><strong>Ngân hàng:</strong> <span id="display-bank"></span></p>
                        <p><strong>Số tài khoản:</strong> <span id="display-account-number"></span></p>
                        <p><a href="#">Xem tài khoản 9 ngân hàng khác (Click để xem)</a></p>
                    </div>
                    <div class="transfer-qr">
                        <img id="vietqr-code" alt="Mã VietQR" crossorigin="anonymous" />
                    </div>
                </div>
            </div>
        </div>

        <button class="screenshot-btn" onclick="takeScreenshot()" aria-label="Chụp và sao chép ảnh màn hình">Chụp ảnh màn hình</button>

        <div class="form-group">
            <label for="account-name">Tên tài khoản:</label>
            <input type="text" id="account-name" placeholder="Nhập tên tài khoản" aria-required="true">
        </div>

        <div class="form-group">
            <label for="amount">Số tiền:</label>
            <input type="text" id="amount" placeholder="Nhập số tiền" aria-required="true">
        </div>

        <div class="form-group">
            <label for="content">Nội dung:</label>
            <input type="text" id="content" placeholder="Nhập nội dung" aria-required="true">
        </div>

        <div class="form-group">
            <label for="bank">Ngân hàng:</label>
            <select id="bank" aria-required="true">
                <option value="">Chọn ngân hàng</option>
                <option value="Agribank - Nông nghiệp và Phát triển Nông thôn Việt Nam">Agribank - Ngân hàng Nông nghiệp và Phát triển Nông thôn Việt Nam</option>
                <option value="Vietcombank - TMCP Ngoại thương Việt Nam">Vietcombank - Ngân hàng TMCP Ngoại thương Việt Nam</option>
                <option value="VietinBank - TMCP Công thương Việt Nam">VietinBank - Ngân hàng TMCP Công thương Việt Nam</option>
                <option value="BIDV - Đầu tư và Phát triển Việt Nam">BIDV - Ngân hàng Đầu tư và Phát triển Việt Nam</option>
                <option value="Techcombank - TMCP Kỹ thương Việt Nam">Techcombank - Ngân hàng TMCP Kỹ thương Việt Nam</option>
                <option value="MBBank - TMCP Quân đội">MBBank - Ngân hàng TMCP Quân đội</option>
                <option value="VPBank - TMCP Việt Nam Thịnh Vượng">VPBank - Ngân hàng TMCP Việt Nam Thịnh Vượng</option>
                <option value="Sacombank - TMCP Sài Gòn Thương Tín">Sacombank - Ngân hàng TMCP Sài Gòn Thương Tín</option>
                <option value="ACB - TMCP Á Châu">ACB - Ngân hàng TMCP Á Châu</option>
                <option value="TPBank - TMCP Tiên Phong">TPBank - Ngân hàng TMCP Tiên Phong</option>
                <option value="SHB - TMCP Sài Gòn Hà Nội">SHB - Ngân hàng TMCP Sài Gòn Hà Nội</option>
                <option value="VIB - TMCP Quốc tế Việt Nam">VIB - Ngân hàng TMCP Quốc tế Việt Nam</option>
                <option value="HDBank - TMCP Phát triển TP.HCM">HDBank - Ngân hàng TMCP Phát triển TP.HCM</option>
                <option value="MSB - TMCP Hàng Hải Việt Nam">MSB - Ngân hàng TMCP Hàng Hải Việt Nam</option>
                <option value="DongA Bank - TMCP Đông Á">DongA Bank - Ngân hàng TMCP Đông Á</option>
                <option value="Eximbank - TMCP Xuất nhập khẩu Việt Nam">Eximbank - Ngân hàng TMCP Xuất nhập khẩu Việt Nam</option>
                <option value="OCB - TMCP Phương Đông">OCB - Ngân hàng TMCP Phương Đông</option>
                <option value="VietABank - TMCP Việt Á">VietABank - Ngân hàng TMCP Việt Á</option>
                <option value="SaigonBank - TMCP Sài Gòn Công thương">SaigonBank - Ngân hàng TMCP Sài Gòn Công thương</option>
                <option value="NamABank - TMCP Nam Á">NamABank - Ngân hàng TMCP Nam Á</option>
                <option value="PG Bank - TMCP Xăng dầu Petrolimex">PG Bank - Ngân hàng TMCP Xăng dầu Petrolimex</option>
                <option value="GP Bank - TMCP Dầu khí Toàn cầu">GP Bank - Ngân hàng TMCP Dầu khí Toàn cầu</option>
                <option value="LienVietPostBank - TMCP Bưu điện Liên Việt">LienVietPostBank - Ngân hàng TMCP Bưu điện Liên Việt</option>
                <option value="BacABank - TMCP Bắc Á">BacABank - Ngân hàng TMCP Bắc Á</option>
                <option value="ABBank - TMCP An Bình">ABBank - Ngân hàng TMCP An Bình</option>
            </select>
        </div>

        <div class="form-group">
            <label for="account-number">Số tài khoản:</label>
            <input type="text" id="account-number" placeholder="Nhập số tài khoản" aria-required="true">
        </div>
    </div>

    <script>
        // Danh sách mã BIN ngân hàng
        const bankBins = {
            "Agribank - Nông nghiệp và Phát triển Nông thôn Việt Nam": "970405",
            "Vietcombank - TMCP Ngoại thương Việt Nam": "970436",
            "VietinBank - TMCP Công thương Việt Nam": "970415",
            "BIDV - Đầu tư và Phát triển Việt Nam": "970418",
            "Techcombank - TMCP Kỹ thương Việt Nam": "970407",
            "MBBank - TMCP Quân đội": "970422",
            "VPBank - TMCP Việt Nam Thịnh Vượng": "970432",
            "Sacombank - TMCP Sài Gòn Thương Tín": "970403",
            "ACB - TMCP Á Châu": "970416",
            "TPBank - TMCP Tiên Phong": "970423",
            "SHB - TMCP Sài Gòn Hà Nội": "970443",
            "VIB - TMCP Quốc tế Việt Nam": "970441",
            "HDBank - TMCP Phát triển TP.HCM": "970437",
            "MSB - TMCP Hàng Hải Việt Nam": "970426",
            "DongA Bank - TMCP Đông Á": "970406",
            "Eximbank - TMCP Xuất nhập khẩu Việt Nam": "970431",
            "OCB - TMCP Phương Đông": "970448",
            "VietABank - TMCP Việt Á": "970427",
            "SaigonBank - TMCP Sài Gòn Công thương": "970400",
            "NamABank - TMCP Nam Á": "970428",
            "PG Bank - TMCP Xăng dầu Petrolimex": "970430",
            "GP Bank - TMCP Dầu khí Toàn cầu": "970408",
            "LienVietPostBank - TMCP Bưu điện Liên Việt": "970449",
            "BacABank - TMCP Bắc Á": "970409",
            "ABBank - TMCP An Bình": "970425"
        };

        // Hàm loại bỏ dấu tiếng Việt nhưng giữ nguyên dấu cách và chuyển thành in hoa
        function removeVietnameseDiacriticsAndUppercase(str) {
            return str
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .toUpperCase();
        }

        // Hàm tạo URL mã VietQR
        function generateVietQRUrl(bank, accountNumber, accountName) {
            const bin = bankBins[bank];
            if (!bin || !accountNumber || !accountName) return null;
            const cleanAccountName = removeVietnameseDiacriticsAndUppercase(accountName);
            return `https://img.vietqr.io/image/${bin}-${accountNumber}-compact.png?accountName=${encodeURIComponent(cleanAccountName)}`;
        }

        // Hàm preload hình ảnh VietQR
        function preloadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.src = url;
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('Không thể tải hình ảnh VietQR'));
            });
        }

		// Hàm cập nhật mã QR
		async function updateVietQR() {
			const bank = document.getElementById("bank").value;
			const accountNumber = document.getElementById("account-number").value.trim();
			const accountName = document.getElementById("account-name").value.trim();
			const qrImg = document.getElementById("vietqr-code");

			// Kiểm tra xem tất cả các trường có được điền đầy đủ và hợp lệ không
			if (!bank || !accountNumber || !accountName) {
				qrImg.src = "";
				qrImg.style.display = "none";
				showToast('Vui lòng điền đầy đủ thông tin: Tên tài khoản, Số tài khoản và Ngân hàng!');
				return;
			}

			// Kiểm tra thêm định dạng số tài khoản (chỉ chứa số)
			if (!/^\d+$/.test(accountNumber)) {
				qrImg.src = "";
				qrImg.style.display = "none";
				showToast('Số tài khoản chỉ được chứa chữ số!');
				return;
			}

			// Tạo URL mã VietQR
			const qrUrl = generateVietQRUrl(bank, accountNumber, accountName);

			if (qrUrl) {
				try {
					await preloadImage(qrUrl);
					qrImg.src = qrUrl;
					qrImg.style.display = "inline";
				} catch (err) {
					console.error('Lỗi khi tải mã VietQR:', err);
					qrImg.src = "";
					qrImg.style.display = "none";
					showToast('Không thể tải mã VietQR. Vui lòng kiểm tra thông tin!');
				}
			} else {
				qrImg.src = "";
				qrImg.style.display = "none";
				showToast('Thông tin không hợp lệ để tạo mã VietQR!');
			}
		}
		// Hàm sinh chuỗi ngẫu nhiên 12 ký tự, đảm bảo có 0 và O
		function generateRandomContent() {
			const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
			let result = '';
			
			// Sinh 10 ký tự ngẫu nhiên
			for (let i = 0; i < 10; i++) {
				const randomIndex = Math.floor(Math.random() * chars.length);
				result += chars[randomIndex];
			}
			
			// Thêm 0 và O vào vị trí ngẫu nhiên
			const mustHave = ['0', 'O'];
			for (let char of mustHave) {
				const randomPos = Math.floor(Math.random() * result.length);
				result = result.slice(0, randomPos) + char + result.slice(randomPos);
			}
			
			// Nếu chuỗi dài hơn 12 ký tự, cắt bớt
			result = result.slice(0, 12);
			
			// Nếu chuỗi thiếu ký tự, thêm ngẫu nhiên
			while (result.length < 12) {
				const randomIndex = Math.floor(Math.random() * chars.length);
				result += chars[randomIndex];
			}
			
			return result;
		}
        // Lấy các phần tử input và display
        const accountNameInput = document.getElementById('account-name');
        const amountInput = document.getElementById('amount');
        const contentInput = document.getElementById('content');
        const bankInput = document.getElementById('bank');
        const accountNumberInput = document.getElementById('account-number');

        const displayAccountName = document.getElementById('display-account-name');
        const displayAmount = document.getElementById('display-amount');
        const displayContent = document.getElementById('display-content');
        const displayBank = document.getElementById('display-bank');
        const displayAccountNumber = document.getElementById('display-account-number');

        // Hàm lưu dữ liệu vào localStorage
        function saveToLocalStorage() {
            localStorage.setItem('accountName', accountNameInput.value);
            localStorage.setItem('amount', amountInput.value);
            localStorage.setItem('content', contentInput.value);
            localStorage.setItem('bank', bankInput.value);
            localStorage.setItem('accountNumber', accountNumberInput.value);
        }

        // Hàm khôi phục dữ liệu từ localStorage
        function restoreFromLocalStorage() {
            accountNameInput.value = localStorage.getItem('accountName') || '';
            amountInput.value = localStorage.getItem('amount') || '';
            contentInput.value = localStorage.getItem('content') || '';
            bankInput.value = localStorage.getItem('bank') || '';
            accountNumberInput.value = localStorage.getItem('accountNumber') || '';

            // Cập nhật hiển thị
            displayAccountName.textContent = accountNameInput.value || '';
            displayAmount.textContent = amountInput.value || '';
            displayContent.textContent = contentInput.value || '';
            displayBank.textContent = bankInput.value || '';
            displayAccountNumber.textContent = accountNumberInput.value || '';

            updateVietQR();
        }

        // Hàm xử lý và chuẩn hóa giá trị
        function normalizeInput(inputElement, displayElement, isText = false) {
            let value = inputElement.value.trimStart();
            if (isText) {
                value = removeVietnameseDiacriticsAndUppercase(value);
            }
            inputElement.value = value;
            displayElement.textContent = value || '';
            saveToLocalStorage(); // Lưu ngay khi thay đổi
            return value;
        }

		// Tạo phiên bản debounce của updateVietQR (chờ 1000ms)
		const debouncedUpdateVietQR = debounce(updateVietQR, 1000);

		// Xử lý sự kiện input và change
		accountNameInput.addEventListener('input', () => {
			normalizeInput(accountNameInput, displayAccountName, true);
			saveToLocalStorage();
			debouncedUpdateVietQR();
		});

		bankInput.addEventListener('change', () => {
			const value = bankInput.value;
			displayBank.textContent = value || '';
			saveToLocalStorage();
			debouncedUpdateVietQR();
		});

		accountNumberInput.addEventListener('input', () => {
			const value = accountNumberInput.value.replace(/[^0-9]/g, '');
			accountNumberInput.value = value;
			displayAccountNumber.textContent = value || '';
			saveToLocalStorage();
			debouncedUpdateVietQR();
		});

		// Giữ nguyên các sự kiện input khác để cập nhật hiển thị và lưu trữ
		amountInput.addEventListener('input', () => {
			let value = amountInput.value.replace(/[^0-9,]/g, '');
			if (value) {
				value = parseFloat(value.replace(/,/g, '')).toLocaleString('en-US') + ' VNĐ';
			}
			amountInput.value = value;
			displayAmount.textContent = value || '';
			
			// Sinh nội dung ngẫu nhiên cho contentInput
			const randomContent = generateRandomContent();
			contentInput.value = randomContent;
			displayContent.textContent = randomContent || '';
			
			saveToLocalStorage();
		});

		contentInput.addEventListener('input', () => {
			normalizeInput(contentInput, displayContent, true);
			saveToLocalStorage();
		});

        // Khởi tạo: khôi phục dữ liệu từ localStorage
        document.addEventListener("DOMContentLoaded", () => {
            restoreFromLocalStorage();
        });

		// Thêm chức năng copy trong mục Chuyển khoản
		document.querySelectorAll('.bank-transfer .copy').forEach(copyBtn => {
			copyBtn.addEventListener('click', () => {
				const contentInput = document.getElementById('content');
				const textToCopy = contentInput.value.trim();
				if (textToCopy) {
					navigator.clipboard.writeText(textToCopy).then(() => {
						showToast('Đã sao chép nội dung: ' + textToCopy);
					}).catch(err => {
						console.error('Lỗi khi sao chép:', err);
						showToast('Không thể sao chép, vui lòng thử lại!');
					});
				} else {
					showToast('Nội dung trống, không thể sao chép!');
				}
			});
			copyBtn.addEventListener('keydown', (e) => {
				if (e.key === 'Enter' || e.key === ' ') {
					e.preventDefault();
					copyBtn.click();
				}
			});
		});

        // Hàm hiển thị toast
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // Hàm chụp ảnh màn hình
        async function takeScreenshot() {
            const qrImg = document.getElementById("vietqr-code");
            if (qrImg.src) {
                try {
                    await preloadImage(qrImg.src);
                } catch (err) {
                    console.error('Lỗi tải hình ảnh VietQR:', err);
                    showToast('Không thể tải mã VietQR để chụp ảnh!');
                    return;
                }
            }

            const element = document.getElementById('screenshot-area');
            html2canvas(element, { 
                backgroundColor: '#fff',
                useCORS: true
            }).then(canvas => {
                canvas.toBlob(blob => {
                    if (navigator.clipboard && ClipboardItem) {
                        const item = new ClipboardItem({ 'image/png': blob });
                        navigator.clipboard.write([item]).then(() => {
                            showToast('Ảnh đã được sao chép vào clipboard!');
                        }).catch(err => {
                            console.error('Lỗi khi sao chép ảnh:', err);
                            fallbackDownload(canvas);
                        });
                    } else {
                        fallbackDownload(canvas);
                    }
                });
            }).catch(err => {
                console.error('Lỗi khi chụp ảnh màn hình:', err);
                showToast('Có lỗi xảy ra khi chụp ảnh màn hình!');
            });
        }

        // Hàm tải ảnh xuống
        function fallbackDownload(canvas) {
            const link = document.createElement('a');
            link.download = 'payment-screenshot.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            showToast('Ảnh đã được tải xuống!');
        }

		// Hàm debounce
		function debounce(func, wait) {
			let timeout;
			return function executedFunction(...args) {
				const later = () => {
					clearTimeout(timeout);
					func(...args);
				};
				clearTimeout(timeout);
				timeout = setTimeout(later, wait);
			};
		}
    </script>
</body>
</html>
